<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯å‘¨ä¸€å¥½è¯„ - ç½‘é¡µç‰ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #faf8f5 0%, #f0e6d2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden; display: flex; flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        .header {
            background: linear-gradient(135deg, #D2B48C 0%, #DEB887 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .main-content { flex: 1; padding: 40px; }
        .upload-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .upload-section:hover { border-color: #D2B48C; background: #f7fafc; }
        .folder-upload {
            text-align: center; margin-bottom: 30px;
        }
        .folder-upload-button {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 20px 40px; background: #D2B48C; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s; font-size: 18px; font-weight: 500;
        }
        .folder-upload-button:hover { background: #DEB887; transform: translateY(-2px); }
        .file-mapping {
            display: none; margin-top: 20px;
        }
        .file-mapping h3 { color: #2d3748; margin-bottom: 15px; }
        .file-mapping-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;
        }
        .mapping-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .mapping-item.found { border-color: #48bb78; }
        .mapping-item.missing { border-color: #f56565; }
        .mapping-info { flex: 1; }
        .mapping-title { font-weight: 600; color: #2d3748; margin-bottom: 5px; }
        .mapping-filename { font-size: 12px; color: #666; }
        .mapping-status {
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            font-weight: 500;
        }
        .mapping-status.found { background: #48bb78; color: white; }
        .mapping-status.missing { background: #f56565; color: white; }
        .date-input-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px solid #e2e8f0;
        }
        .date-input-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px; margin-bottom: 20px;
        }
        .date-input-item { display: flex; flex-direction: column; }
        .date-input-item label { font-weight: 500; color: #4a5568; margin-bottom: 8px; }
        .date-input { 
            padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 14px; transition: border-color 0.3s;
        }
        .date-input:focus { outline: none; border-color: #D2B48C; }
        .process-section { text-align: center; margin: 40px 0; }
        .btn {
            padding: 15px 30px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 500; cursor: pointer;
            transition: all 0.3s; display: inline-flex; align-items: center;
            gap: 10px; margin: 0 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #D2B48C; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .progress-section { margin: 30px 0; display: none; }
        .progress-bar {
            width: 100%; height: 20px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #D2B48C, #DEB887);
            width: 0%; transition: width 0.3s;
        }
        .progress-text { text-align: center; color: #666; font-size: 14px; }
        .results-section { margin-top: 30px; display: none; }
        .results-section h3 { color: #2d3748; margin-bottom: 20px; }
        .download-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .download-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .download-btn {
            padding: 8px 16px; background: #48bb78; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; transition: background 0.3s;
        }
        .download-btn:hover { background: #38a169; }
        .log-section { margin-top: 30px; display: none; }
        .log-container {
            background: #1a202c; color: #e2e8f0; padding: 20px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.5; max-height: 300px; overflow-y: auto;
        }
        .log-entry { margin-bottom: 5px; }
        .log-entry.success { color: #48bb78; }
        .log-entry.error { color: #f56565; }
        .log-entry.info { color: #4299e1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ¯å‘¨ä¸€å¥½è¯„</h1>
        </div>
        <div class="main-content">
            <!-- æ—¥æœŸè¾“å…¥åŒºåŸŸ -->
            <div class="date-input-section">
                <h2>ğŸ“… æ—¥æœŸä¿¡æ¯</h2>
                <div class="date-input-grid">
                    <div class="date-input-item">
                        <label>å¹´ä»½</label>
                        <input type="text" class="date-input" id="yearInput" value="2024" placeholder="å¦‚ï¼š2024">
                    </div>
                    <div class="date-input-item"></div>
                    <div class="date-input-item"></div>
                    <div class="date-input-item"></div>
                </div>
                <div class="date-input-grid">
                    <div class="date-input-item">
                        <label>èµ·å§‹æœˆ</label>
                        <input type="text" class="date-input" id="startMonthInput" value="4" placeholder="å¦‚ï¼š4">
                    </div>
                    <div class="date-input-item">
                        <label>èµ·å§‹æ—¥</label>
                        <input type="text" class="date-input" id="startDayInput" value="21" placeholder="å¦‚ï¼š21">
                    </div>
                    <div class="date-input-item">
                        <label>ç»“æŸæœˆ</label>
                        <input type="text" class="date-input" id="endMonthInput" value="4" placeholder="å¦‚ï¼š4">
                    </div>
                    <div class="date-input-item">
                        <label>ç»“æŸæ—¥</label>
                        <input type="text" class="date-input" id="endDayInput" value="27" placeholder="å¦‚ï¼š27">
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶å¤¹ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <h2>ğŸ“ æ–‡ä»¶å¤¹ä¸Šä¼ </h2>
                <div class="folder-upload">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" accept=".xlsx,.jpg,.jpeg">
                    <button class="folder-upload-button" onclick="document.getElementById('folderInput').click()">
                        ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹
                    </button>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        è¯·ç¡®ä¿æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä»¥æ•°å­—1-5å¼€å¤´å‘½åï¼ˆå¦‚ï¼š1æŠ–éŸ³å›¾ç‰‡.jpg, 2æŠ–éŸ³æ•°æ®.xlsxç­‰ï¼‰
                    </div>
                </div>
                
                <div id="fileMapping" class="file-mapping">
                    <h3>ğŸ“‹ æ–‡ä»¶è¯†åˆ«ç»“æœ</h3>
                    <div class="file-mapping-grid">
                        <div class="mapping-item" id="mapping-1">
                            <div class="mapping-info">
                                <div class="mapping-title">1ï¸âƒ£ æŠ–éŸ³å¥½è¯„å›¾ç‰‡</div>
                                <div class="mapping-filename" id="file-1-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-1-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-2">
                            <div class="mapping-info">
                                <div class="mapping-title">2ï¸âƒ£ æŠ–éŸ³å¥½è¯„Excel</div>
                                <div class="mapping-filename" id="file-2-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-2-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-3">
                            <div class="mapping-info">
                                <div class="mapping-title">3ï¸âƒ£ ç¾å›¢å¥½è¯„å›¾ç‰‡</div>
                                <div class="mapping-filename" id="file-3-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-3-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-4">
                            <div class="mapping-info">
                                <div class="mapping-title">4ï¸âƒ£ ç¾å›¢å¥½è¯„Excel</div>
                                <div class="mapping-filename" id="file-4-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-4-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-5">
                            <div class="mapping-info">
                                <div class="mapping-title">5ï¸âƒ£ å›¢è´­é—¨åº—åå¯¹åº”è¡¨</div>
                                <div class="mapping-filename" id="file-5-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-5-status">ç¼ºå¤±</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="process-section">
                <button class="btn btn-primary" onclick="processData()" id="processBtn">ğŸš€ å¼€å§‹å¤„ç†</button>
                <button class="btn btn-success" onclick="downloadAllAsZip()" id="downloadAllBtn" style="display: none;">ğŸ“¦ æ‰“åŒ…ä¸‹è½½å…¨éƒ¨</button>
            </div>

            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">å‡†å¤‡å¼€å§‹å¤„ç†...</div>
            </div>

            <div class="results-section" id="resultsSection">
                <h3>ğŸ“‹ å¤„ç†ç»“æœ</h3>
                <div class="download-list" id="downloadList"></div>
            </div>

            <div class="log-section" id="logSection">
                <h3>ğŸ“ å¤„ç†æ—¥å¿—</h3>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let uploadedFiles = {};
        let processedFiles = {};
        let fileMapping = {
            '1': 'douyinImage',
            '2': 'douyinExcel', 
            '3': 'meituanImage',
            '4': 'meituanExcel',
            '5': 'mappingFile'
        };
        let fileNames = {
            '1': 'æŠ–éŸ³å¥½è¯„å›¾ç‰‡',
            '2': 'æŠ–éŸ³å¥½è¯„Excel',
            '3': 'ç¾å›¢å¥½è¯„å›¾ç‰‡', 
            '4': 'ç¾å›¢å¥½è¯„Excel',
            '5': 'å›¢è´­é—¨åº—åå¯¹åº”è¡¨'
        };

        // æ–‡ä»¶å¤¹ä¸Šä¼ ç›‘å¬å™¨
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            log(`ğŸ“‚ é€‰æ‹©äº†æ–‡ä»¶å¤¹ï¼ŒåŒ…å« ${files.length} ä¸ªæ–‡ä»¶`, 'info');
            
            // é‡ç½®æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
            resetFileMapping();
            
            // å¤„ç†æ–‡ä»¶
            files.forEach(file => {
                const firstChar = file.name.charAt(0);
                if (fileMapping[firstChar]) {
                    uploadedFiles[fileMapping[firstChar]] = file;
                    updateFileMapping(firstChar, file.name);
                    log(`âœ… è¯†åˆ«æ–‡ä»¶: ${file.name} â†’ ${fileNames[firstChar]}`, 'success');
                } else {
                    log(`âš ï¸ æ— æ³•è¯†åˆ«æ–‡ä»¶: ${file.name} (æ–‡ä»¶åä¸æ˜¯ä»¥1-5å¼€å¤´)`, 'warning');
                }
            });
            
            // æ˜¾ç¤ºæ–‡ä»¶æ˜ å°„ç»“æœ
            document.getElementById('fileMapping').style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å·²ä¸Šä¼ 
            const missingFiles = Object.keys(fileMapping).filter(num => !uploadedFiles[fileMapping[num]]);
            if (missingFiles.length === 0) {
                log('âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶å·²æ‰¾åˆ°ï¼Œå¯ä»¥å¼€å§‹å¤„ç†', 'success');
            } else {
                log(`âš ï¸ ç¼ºå°‘æ–‡ä»¶: ${missingFiles.map(num => fileNames[num]).join(', ')}`, 'warning');
            }
        });

        // é‡ç½®æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
        function resetFileMapping() {
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`file-${i}-name`).textContent = 'æœªæ‰¾åˆ°';
                document.getElementById(`file-${i}-status`).textContent = 'ç¼ºå¤±';
                document.getElementById(`file-${i}-status`).className = 'mapping-status missing';
                document.getElementById(`mapping-${i}`).className = 'mapping-item missing';
            }
        }

        // æ›´æ–°æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
        function updateFileMapping(number, fileName) {
            document.getElementById(`file-${number}-name`).textContent = fileName;
            document.getElementById(`file-${number}-status`).textContent = 'å·²æ‰¾åˆ°';
            document.getElementById(`file-${number}-status`).className = 'mapping-status found';
            document.getElementById(`mapping-${number}`).className = 'mapping-item found';
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logSection.style.display = 'block';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }

        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        // è¯»å–Excelæ–‡ä»¶
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        log(`è¯»å–æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // è·å–å·¥ä½œè¡¨æ•°æ®
        function getSheetData(workbook, sheetName = null) {
            const sheet = sheetName ? workbook.Sheets[sheetName] : workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            const data = [];
            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                    const cell = sheet[cellAddress];
                    rowData.push(cell ? cell.v : '');
                }
                data.push(rowData);
            }
            return data;
        }

        // åˆ›å»ºå›¾ç‰‡ç”»å¸ƒ
        function createImageCanvas(imageFile) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    resolve({ canvas, ctx, width: img.width, height: img.height });
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(imageFile);
            });
        }

        // ç»˜åˆ¶æ–‡å­—åˆ°ç”»å¸ƒ
        function drawText(ctx, text, x, y, fontSize = 40, color = '#8B4513', fontFamily = 'Arial') {
            ctx.font = `${fontSize}px ${fontFamily}`;
            ctx.fillStyle = color;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(text, x, y);
        }

        // ç»˜åˆ¶è¡¨æ ¼
        function drawTable(ctx, storeCounts, startX, startY, fontSize = 40) {
            const sortedStores = Object.entries(storeCounts)
                .sort(([,a], [,b]) => b - a);
            
            const rankWidth = 100;
            const storeWidth = 200;
            const countWidth = 210;
            const rowHeight = 91;
            
            let y = startY;
            
            // ç»˜åˆ¶è¡¨å¤´
            const rankTextWidth = ctx.measureText('æ’å').width;
            const countTextWidth = ctx.measureText('å¢é•¿æ•°é‡').width;
            drawText(ctx, 'æ’å', startX + (rankWidth - rankTextWidth) / 2, y, fontSize, '#8B4513');
            drawText(ctx, 'é—¨åº—', 550, y, fontSize, '#8B4513');
            drawText(ctx, 'å¢é•¿æ•°é‡', 870 + (countWidth - countTextWidth) / 2, y, fontSize, '#8B4513');
            y += rowHeight;
            
            // ç»˜åˆ¶å‰7ä¸ªé—¨åº—
            for (let i = 0; i < Math.min(7, sortedStores.length); i++) {
                const [store, count] = sortedStores[i];
                const rank = (i >= 3) ? String(i + 1) : '';
                const countText = `${count}ä¸ª`;
                
                const rankNumWidth = ctx.measureText(rank).width;
                const countNumWidth = ctx.measureText(countText).width;
                drawText(ctx, rank, startX + (rankWidth - rankNumWidth) / 2, y, fontSize, '#8B4513');
                drawText(ctx, store, 550, y, fontSize, '#8B4513');
                drawText(ctx, countText, 870 + (countWidth - countNumWidth) / 2, y, fontSize, '#8B4513');
                y += rowHeight;
            }
            
            // ç»˜åˆ¶å7ä¸ªé—¨åº—
            y += 210;
            const rankTextWidth2 = ctx.measureText('æ’å').width;
            const countTextWidth2 = ctx.measureText('å¢é•¿æ•°é‡').width;
            drawText(ctx, 'æ’å', startX + (rankWidth - rankTextWidth2) / 2, y, fontSize, '#000000');
            drawText(ctx, 'é—¨åº—', 550, y, fontSize, '#000000');
            drawText(ctx, 'å¢é•¿æ•°é‡', 870 + (countWidth - countTextWidth2) / 2, y, fontSize, '#000000');
            y += rowHeight;
            
            const startIndex = Math.max(0, sortedStores.length - 7);
            for (let i = startIndex; i < sortedStores.length; i++) {
                const [store, count] = sortedStores[i];
                const rank = String(i + 1);
                const countText = `${count}ä¸ª`;
                
                const rankNumWidth2 = ctx.measureText(rank).width;
                const countNumWidth2 = ctx.measureText(countText).width;
                drawText(ctx, rank, startX + (rankWidth - rankNumWidth2) / 2, y, fontSize, '#000000');
                drawText(ctx, store, 550, y, fontSize, '#000000');
                drawText(ctx, countText, 870 + (countWidth - countNumWidth2) / 2, y, fontSize, '#000000');
                y += rowHeight;
            }
        }

        // å¤„ç†æŠ–éŸ³æ•°æ®
        async function processDouyinData(year, startMonth, startDay, endMonth, endDay) {
            log('å¤„ç†æŠ–éŸ³å¥½è¯„æ•°æ®...', 'info');
            
            // è¯»å–Excelæ•°æ®
            const douyinWorkbook = await readExcelFile(uploadedFiles['douyinExcel']);
            const mappingWorkbook = await readExcelFile(uploadedFiles['mappingFile']);
            
            // è¯»å–æ˜ å°„è¡¨
            const douyinMapping = {};
            const douyinMappingData = getSheetData(mappingWorkbook, mappingWorkbook.SheetNames[1]);
            for (let i = 1; i < douyinMappingData.length; i++) {
                const originalName = douyinMappingData[i][0];
                const mappedName = douyinMappingData[i][1];
                if (originalName && mappedName) {
                    douyinMapping[String(originalName).trim()] = String(mappedName).trim();
                }
            }
            
            // è¯»å–æŠ–éŸ³æ•°æ®
            const douyinData = getSheetData(douyinWorkbook);
            const storeCounts = {};
            
            for (let i = 1; i < douyinData.length; i++) {
                const storeName = douyinData[i][0]; // å‡è®¾ç¬¬ä¸€åˆ—æ˜¯é—¨åº—åç§°
                if (storeName) {
                    const mappedName = douyinMapping[String(storeName).trim()] || String(storeName).trim();
                    storeCounts[mappedName] = (storeCounts[mappedName] || 0) + 1;
                }
            }
            
            log(`æŠ–éŸ³æ•°æ®ç»Ÿè®¡å®Œæˆï¼Œå…± ${Object.keys(storeCounts).length} ä¸ªé—¨åº—`, 'success');
            
            // å¤„ç†å›¾ç‰‡
            const { canvas, ctx, width, height } = await createImageCanvas(uploadedFiles['douyinImage']);
            
            // æ ¼å¼åŒ–æœˆä»½ä¸ºåŒä½æ•°
            const formattedStartMonth = String(startMonth).padStart(2, '0');
            const formattedEndMonth = String(endMonth).padStart(2, '0');
            
            // ç»˜åˆ¶æ ‡é¢˜å’Œæ—¥æœŸ
            drawText(ctx, year, 80, 295, 100, '#8B4513');
            const yearWidth = ctx.measureText(year).width;
            drawText(ctx, formattedStartMonth, 80 + yearWidth + 140, 295, 100, '#8B4513');
            
            // ç»˜åˆ¶æ—¥æœŸæ•°å­—è¡Œ
            drawText(ctx, formattedStartMonth, 300, 630, 60, '#8B4513');
            drawText(ctx, startDay, 325 + 110, 630, 60, '#8B4513');
            drawText(ctx, formattedEndMonth, 300 + 310, 630, 60, '#8B4513');
            drawText(ctx, endDay, 340 + 405, 630, 60, '#8B4513');
            
            // ç»˜åˆ¶è¡¨æ ¼
            drawTable(ctx, storeCounts, 275, 900, 40);
            
            // è½¬æ¢ä¸ºBlob
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
        }

        // å¤„ç†ç¾å›¢æ•°æ®
        async function processMeituanData(year, startMonth, startDay, endMonth, endDay) {
            log('å¤„ç†ç¾å›¢å¥½è¯„æ•°æ®...', 'info');
            
            // è¯»å–Excelæ•°æ®
            const meituanWorkbook = await readExcelFile(uploadedFiles['meituanExcel']);
            const mappingWorkbook = await readExcelFile(uploadedFiles['mappingFile']);
            
            // è¯»å–æ˜ å°„è¡¨
            const meituanMapping = {};
            const meituanMappingData = getSheetData(mappingWorkbook, mappingWorkbook.SheetNames[0]);
            for (let i = 1; i < meituanMappingData.length; i++) {
                const originalName = meituanMappingData[i][0];
                const mappedName = meituanMappingData[i][1];
                if (originalName && mappedName) {
                    meituanMapping[String(originalName).trim()] = String(mappedName).trim();
                }
            }
            
            // è¯»å–ç¾å›¢æ•°æ®
            const meituanData = getSheetData(meituanWorkbook);
            const storeCounts = {};
            
            // ä½¿ç”¨ç¬¬Cåˆ—ï¼ˆç´¢å¼•2ï¼‰ä½œä¸ºé—¨åº—åç§°ï¼Œä¸Pythonç¨‹åºä¸€è‡´
            for (let i = 1; i < meituanData.length; i++) {
                const storeName = meituanData[i][2]; // ç¬¬Cåˆ—ï¼ˆè¯„ä»·é—¨åº—åˆ—ï¼‰
                if (storeName) {
                    const mappedName = meituanMapping[String(storeName).trim()] || String(storeName).trim();
                    storeCounts[mappedName] = (storeCounts[mappedName] || 0) + 1;
                }
            }
            
            log(`ç¾å›¢æ•°æ®ç»Ÿè®¡å®Œæˆï¼Œå…± ${Object.keys(storeCounts).length} ä¸ªé—¨åº—`, 'success');
            
            // å¤„ç†å›¾ç‰‡
            const { canvas, ctx, width, height } = await createImageCanvas(uploadedFiles['meituanImage']);
            
            // æ ¼å¼åŒ–æœˆä»½ä¸ºåŒä½æ•°
            const formattedStartMonth = String(startMonth).padStart(2, '0');
            const formattedEndMonth = String(endMonth).padStart(2, '0');
            
            // ç»˜åˆ¶æ ‡é¢˜å’Œæ—¥æœŸ
            drawText(ctx, year, 80, 295, 100, '#8B4513');
            const yearWidth = ctx.measureText(year).width;
            drawText(ctx, formattedStartMonth, 80 + yearWidth + 140, 295, 100, '#8B4513');
            
            // ç»˜åˆ¶æ—¥æœŸæ•°å­—è¡Œ
            drawText(ctx, formattedStartMonth, 300, 630, 60, '#8B4513');
            drawText(ctx, startDay, 325 + 110, 630, 60, '#8B4513');
            drawText(ctx, formattedEndMonth, 300 + 310, 630, 60, '#8B4513');
            drawText(ctx, endDay, 340 + 405, 630, 60, '#8B4513');
            
            // ç»˜åˆ¶è¡¨æ ¼
            drawTable(ctx, storeCounts, 275, 900, 40);
            
            // è½¬æ¢ä¸ºBlob
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
        }

        // æ·»åŠ ä¸‹è½½é¡¹åˆ°ç»“æœåˆ—è¡¨
        function addDownloadItem(filename, blob) {
            const downloadList = document.getElementById('downloadList');
            const item = document.createElement('div');
            item.className = 'download-item';
            
            const size = (blob.size / 1024).toFixed(1) + ' KB';
            
            item.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${filename}</div>
                    <div class="file-size">å¤§å°: ${size}</div>
                </div>
                <button class="download-btn" onclick="downloadFile('${filename}')">ä¸‹è½½</button>
            `;
            
            downloadList.appendChild(item);
            processedFiles[filename] = blob;
        }

        // ä¸‹è½½å•ä¸ªæ–‡ä»¶
        function downloadFile(filename) {
            const blob = processedFiles[filename];
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ä¸»è¦å¤„ç†å‡½æ•°
        async function processData() {
            // æ£€æŸ¥å¿…éœ€æ–‡ä»¶
            const requiredFiles = ['douyinImage', 'douyinExcel', 'meituanImage', 'meituanExcel', 'mappingFile'];
            const missingFiles = requiredFiles.filter(fileId => !uploadedFiles[fileId]);
            
            if (missingFiles.length > 0) {
                const missingFileNames = missingFiles.map(fileId => {
                    for (const [num, id] of Object.entries(fileMapping)) {
                        if (id === fileId) return fileNames[num];
                    }
                    return fileId;
                });
                alert(`è¯·å…ˆä¸Šä¼ æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶ï¼\nç¼ºå°‘çš„æ–‡ä»¶ï¼š${missingFileNames.join(', ')}`);
                return;
            }
            
            // æ£€æŸ¥æ—¥æœŸè¾“å…¥
            const year = document.getElementById('yearInput').value.trim();
            const startMonth = document.getElementById('startMonthInput').value.trim();
            const startDay = document.getElementById('startDayInput').value.trim();
            const endMonth = document.getElementById('endMonthInput').value.trim();
            const endDay = document.getElementById('endDayInput').value.trim();
            
            if (!year || !startMonth || !startDay || !endMonth || !endDay) {
                alert('è¯·å¡«å†™æ‰€æœ‰æ—¥æœŸä¿¡æ¯ï¼');
                return;
            }
            
            showProgress();
            log('ğŸš€ å¼€å§‹å¤„ç†æ•°æ®...', 'info');
            
            try {
                updateProgress(20, 'å¤„ç†æŠ–éŸ³æ•°æ®...');
                const douyinBlob = await processDouyinData(year, startMonth, startDay, endMonth, endDay);
                addDownloadItem('æŠ–éŸ³å¥½è¯„_æ ‡æ³¨.jpg', douyinBlob);
                
                updateProgress(60, 'å¤„ç†ç¾å›¢æ•°æ®...');
                const meituanBlob = await processMeituanData(year, startMonth, startDay, endMonth, endDay);
                addDownloadItem('ç¾å›¢å¥½è¯„_æ ‡æ³¨.jpg', meituanBlob);
                
                updateProgress(100, 'å¤„ç†å®Œæˆï¼');
                log('âœ… æ‰€æœ‰å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼', 'success');
                
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('downloadAllBtn').style.display = 'inline-flex';
                hideProgress();
                
            } catch (error) {
                log(`âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
                console.error('å¤„ç†é”™è¯¯:', error);
                hideProgress();
            }
        }

        // ä¸‹è½½å…¨éƒ¨æ–‡ä»¶ä¸ºZIPå‹ç¼©åŒ…
        async function downloadAllAsZip() {
            if (Object.keys(processedFiles).length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶ï¼');
                return;
            }

            log('ğŸ“¦ å¼€å§‹åˆ›å»ºZIPå‹ç¼©åŒ…...', 'info');
            
            try {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                for (const [filename, blob] of Object.entries(processedFiles)) {
                    zip.file(filename, blob);
                    log(`ğŸ“ æ·»åŠ æ–‡ä»¶åˆ°å‹ç¼©åŒ…: ${filename}`, 'info');
                }
                
                log('ğŸ“¦ æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æ¯å‘¨ä¸€å¥½è¯„æ•°ç»Ÿè®¡ç»“æœ_${timestamp}.zip`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                log('âœ… ZIPå‹ç¼©åŒ…ä¸‹è½½å®Œæˆï¼', 'success');
                log(`ğŸ“¦ æ–‡ä»¶åŒ…å« ${Object.keys(processedFiles).length} ä¸ªå›¾ç‰‡æ–‡ä»¶`, 'info');
                
            } catch (error) {
                log(`âŒ åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
                console.error('ZIPåˆ›å»ºé”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“Š æ¯å‘¨ä¸€å¥½è¯„å·²å°±ç»ª', 'success');
            log('è¯·é€‰æ‹©åŒ…å«æ‰€éœ€æ–‡ä»¶çš„æ–‡ä»¶å¤¹', 'info');
        });
    </script>
</body>
</html>
